<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - Plugin Store</title>
    <style>
        :root{--bg-primary:#ffffff;--text-primary:#333;--text-secondary:#666;--border-color:#e5e7eb;--card-bg:#ffffff;--tag-bg:#f3f4f6;--footer-bg:#6b7280}
        body.dark-mode{--bg-primary:#1a1a1a;--text-primary:#e5e5e5;--text-secondary:#b3b3b3;--border-color:#404040;--card-bg:#2d2d2d;--tag-bg:#404040;--footer-bg:#1f1f1f}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',sans-serif;background:var(--bg-primary);min-height:100vh;padding:20px;padding-bottom:80px}
        .container{max-width:1000px;margin:0 auto}
        header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        h1{color:#667eea}
        .btn{padding:10px 16px;border:none;border-radius:8px;font-weight:bold;cursor:pointer}
        .btn-primary{background:#667eea;color:#fff}
        .btn-secondary{background:var(--tag-bg);color:#667eea}
        .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:18px;margin-bottom:14px}
        .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
        .meta{color:var(--text-secondary);font-size:0.9em;margin-top:6px}
        .theme-toggle{position:fixed;top:20px;right:20px;background:var(--card-bg);border:2px solid var(--border-color);padding:10px 14px;border-radius:50px;cursor:pointer}
        footer{position:fixed;bottom:0;left:0;width:100%;background:var(--footer-bg);color:#fff;text-align:center;padding:16px}
        select{padding:8px;border:2px solid var(--border-color);border-radius:8px;background:transparent;color:var(--text-primary)}
        .tag{background:var(--tag-bg);padding:4px 10px;border-radius:10px;font-size:0.85em;color:var(--text-secondary)}
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()" title="í…Œë§ˆ ì „í™˜">ğŸŒ“</button>
    <div class="container">
        <header>
            <h1>ğŸ“œ ë§ˆì´í˜ì´ì§€</h1>
            <div class="row">
                <button class="btn btn-secondary" onclick="window.location.href='index.html'">â¬… ë©”ì¸ìœ¼ë¡œ</button>
            </div>
        </header>
        <div id="userSummary" class="card"></div>
        <h2 style="color:var(--text-primary);margin:10px 0 12px">ë‚´ ë‹¤ìš´ë¡œë“œ</h2>
        <div id="downloadsList"></div>
    </div>
    <footer>ëŒ€í‘œ ê³ ê°€ì˜¨ | ì´ë©”ì¼: <a href="mailto:gogaon036@gmail.com" style="color:#fff">gogaon036@gmail.com</a></footer>

    <script>
    function toggleTheme(){const body=document.body;const isDark=body.classList.toggle('dark-mode');localStorage.setItem('theme',isDark?'dark':'light')}
    (function(){const t=localStorage.getItem('theme');if(t==='dark')document.body.classList.add('dark-mode')})()

    function loadPlugins(){
        try{ return JSON.parse(localStorage.getItem('plugins')||'{}'); }catch(e){ return {}; }
    }
    function loadUser(){
        try{ return JSON.parse(localStorage.getItem('currentUser')||'null'); }catch(e){ return null; }
    }
    function loadAllUsers(){
        try{ return JSON.parse(localStorage.getItem('allUsers')||'{}'); }catch(e){ return {}; }
    }

    function render(){
        const plugins = loadPlugins();
        const user = loadUser();
        if(!user){ window.location.href='login.html'; return; }
        const allUsers = loadAllUsers();
        const balance = allUsers[user.minecraftId]?.balance || 0;

        // ìƒë‹¨ ìš”ì•½
        const us = document.getElementById('userSummary');
        const count = (user.downloads||[]).length;
        us.innerHTML = `
            <div class="row" style="justify-content:space-between">
                <div>
                    <div style="color:var(--text-primary);font-weight:bold;font-size:1.1em">${user.actualMcName||user.username}ë‹˜</div>
                    <div class="meta">ë‹¤ìš´ë¡œë“œ: ${count}ê°œ</div>
                </div>
                <div class="row">
                    <span class="tag">ğŸ’° ì”ì•¡: ${balance.toLocaleString()}ì›</span>
                    <button class="btn btn-primary" onclick="window.location.href='index.html'">í”ŒëŸ¬ê·¸ì¸ ìŠ¤í† ì–´</button>
                </div>
            </div>`;

        // ë‹¤ìš´ë¡œë“œ ë‚´ì—­
        const list = document.getElementById('downloadsList');
        const dls = user.downloads||[];
        if(dls.length===0){ list.innerHTML = `<div class="card" style="text-align:center;color:var(--text-secondary)">ë‹¤ìš´ë¡œë“œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }

        list.innerHTML = dls.map(rec=>{
            const plugin = plugins[rec.pluginId];
            if(!plugin){
                return `<div class="card"><div style="font-weight:bold;color:var(--text-primary)">${rec.pluginName}</div><div class="meta">í”ŒëŸ¬ê·¸ì¸ ì •ë³´ ì—†ìŒ Â· ${rec.date}</div></div>`
            }
            const paid = plugin.type==='paid' && (plugin.price||0)>0;
            const head = `<div class="row" style="justify-content:space-between">
                <div>
                    <div style="font-weight:bold;color:var(--text-primary)">${rec.pluginName}</div>
                    <div class="meta">${plugin.description||''}</div>
                    <div class="row" style="margin-top:8px"><span class="tag">v${plugin.version}</span>${paid?`<span class="tag">ğŸ’° ${(plugin.price||0).toLocaleString()}ì› êµ¬ë§¤</span>`:`<span class="tag">ğŸ ë¬´ë£Œ</span>`}</div>
                    <div class="meta" style="margin-top:6px">ğŸ“… ${rec.date}</div>
                </div>
            </div>`;

            // PartyPluginë§Œ ë²„ì „ ì„ íƒ ì œê³µ
            if(plugin.id==='p10' && plugin.versions){
                const vid = `ver_${plugin.id}`;
                const options = Object.keys(plugin.versions).map(v=>`<option value="${v}">${v}</option>`).join('');
                return `<div class="card">${head}
                    <div class="row" style="margin-top:12px">
                        <select id="${vid}"><option value="">ê¸°ë³¸</option>${options}</select>
                        <button class="btn btn-primary" onclick="reDownloadVersion('${plugin.id}','${vid}')">ë²„ì „ë³„ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>`
            }
            // ê¸°íƒ€ í”ŒëŸ¬ê·¸ì¸: ì¬ë‹¤ìš´ ë²„íŠ¼
            return `<div class="card">${head}
                <div class="row" style="margin-top:12px">
                    <button class="btn btn-primary" onclick="reDownload('${plugin.id}')">ë‹¤ì‹œ ë‹¤ìš´ë¡œë“œ</button>
                </div>
            </div>`
        }).join('');
    }

    window.reDownload=function(pluginId){
        const plugins = loadPlugins();
        const plugin = plugins[pluginId];
        if(!plugin){ alert('í”ŒëŸ¬ê·¸ì¸ ì •ë³´ ì—†ìŒ'); return; }
        const url = plugin.downloadUrl;
        window.open(url,'_blank');
    }
    window.reDownloadVersion=function(pluginId, selectId){
        const plugins = loadPlugins();
        const plugin = plugins[pluginId];
        if(!plugin){ alert('í”ŒëŸ¬ê·¸ì¸ ì •ë³´ ì—†ìŒ'); return; }
        const sel = document.getElementById(selectId);
        const v = sel? sel.value : '';
        let url = plugin.downloadUrl;
        if(v && plugin.versions && plugin.versions[v]) url = plugin.versions[v];
        window.open(url,'_blank');
    }

    const firebaseConfig={apiKey:"AIzaSyB_FsD_GqnENdMGeuzH5Q8tICxn_fgu7OQ",authDomain:"plugmarketdb.firebaseapp.com",databaseURL:"https://plugmarketdb-default-rtdb.firebaseio.com",projectId:"plugmarketdb",storageBucket:"plugmarketdb.firebasestorage.app",messagingSenderId:"142551495005",appId:"1:142551495005:web:6b2b02b9ea53b4198138b4",measurementId:"G-3YMWZPCFWQ"};
    firebase.initializeApp(firebaseConfig);
    const database=firebase.database();
    function setupRealtimeSync(){
        const u=loadUser();
        if(!u||!u.minecraftId){ render(); return; }
        try{
            database.ref(`users/${u.minecraftId}/balance`).on('value',(snap)=>{
                const b=snap.val()||0;
                const all=loadAllUsers();
                if(!all[u.minecraftId]) all[u.minecraftId]={minecraftId:u.minecraftId,balance:0};
                all[u.minecraftId].balance=b;
                localStorage.setItem('allUsers',JSON.stringify(all));
                render();
            });
            database.ref(`users/${u.minecraftId}/downloads`).on('value',(snap)=>{
                const val=snap.val()||{};
                const list=Array.isArray(val)?val:Object.values(val);
                const cu=loadUser();
                if(cu){ cu.downloads=list; localStorage.setItem('currentUser',JSON.stringify(cu)); }
                render();
            });
        }catch(e){ render(); }
    }
    document.addEventListener('DOMContentLoaded', setupRealtimeSync);
    </script>
</body>
</html>
