<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - Plugin Store</title>
    <style>
        :root{--bg-primary:#ffffff;--text-primary:#333;--text-secondary:#666;--border-color:#e5e7eb;--card-bg:#ffffff;--tag-bg:#f3f4f6;--footer-bg:#6b7280}
        body.dark-mode{--bg-primary:#1a1a1a;--text-primary:#e5e5e5;--text-secondary:#b3b3b3;--border-color:#404040;--card-bg:#2d2d2d;--tag-bg:#404040;--footer-bg:#1f1f1f}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',sans-serif;background:var(--bg-primary);min-height:100vh;padding:20px;padding-bottom:80px}
        .container{max-width:1000px;margin:0 auto}
        header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        h1{color:#667eea}
        .btn{padding:10px 16px;border:none;border-radius:8px;font-weight:bold;cursor:pointer}
        .btn-primary{background:#667eea;color:#fff}
        .btn-secondary{background:var(--tag-bg);color:#667eea}
        .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:18px;margin-bottom:14px}
        .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
        .meta{color:var(--text-secondary);font-size:0.9em;margin-top:6px}
        .theme-toggle{position:fixed;top:20px;right:20px;background:var(--card-bg);border:2px solid var(--border-color);padding:10px 14px;border-radius:50px;cursor:pointer}
        footer{position:fixed;bottom:0;left:0;width:100%;background:var(--footer-bg);color:#fff;text-align:center;padding:16px}
        select{padding:8px;border:2px solid var(--border-color);border-radius:8px;background:transparent;color:var(--text-primary)}
        .tag{background:var(--tag-bg);padding:4px 10px;border-radius:10px;font-size:0.85em;color:var(--text-secondary)}
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()" title="테마 전환">🌓</button>
    <div class="container">
        <header>
            <h1>📜 마이페이지</h1>
            <div class="row">
                <button class="btn btn-secondary" onclick="window.location.href='index.html'">⬅ 메인으로</button>
            </div>
        </header>
        <div id="userSummary" class="card"></div>
        <h2 style="color:var(--text-primary);margin:10px 0 12px">내 다운로드</h2>
        <div id="downloadsList"></div>
    </div>
    <footer>대표 고가온 | 이메일: <a href="mailto:gogaon036@gmail.com" style="color:#fff">gogaon036@gmail.com</a></footer>

    <script>
    function toggleTheme(){const body=document.body;const isDark=body.classList.toggle('dark-mode');localStorage.setItem('theme',isDark?'dark':'light')}
    (function(){const t=localStorage.getItem('theme');if(t==='dark')document.body.classList.add('dark-mode')})()

    function loadPlugins(){
        try{ return JSON.parse(localStorage.getItem('plugins')||'{}'); }catch(e){ return {}; }
    }
    function loadUser(){
        try{ return JSON.parse(localStorage.getItem('currentUser')||'null'); }catch(e){ return null; }
    }
    function loadAllUsers(){
        try{ return JSON.parse(localStorage.getItem('allUsers')||'{}'); }catch(e){ return {}; }
    }

    function render(){
        const plugins = loadPlugins();
        const user = loadUser();
        if(!user){ window.location.href='login.html'; return; }
        const allUsers = loadAllUsers();
        const balance = allUsers[user.minecraftId]?.balance || 0;

        // 상단 요약
        const us = document.getElementById('userSummary');
        const count = (user.downloads||[]).length;
        us.innerHTML = `
            <div class="row" style="justify-content:space-between">
                <div>
                    <div style="color:var(--text-primary);font-weight:bold;font-size:1.1em">${user.actualMcName||user.username}님</div>
                    <div class="meta">다운로드: ${count}개</div>
                </div>
                <div class="row">
                    <span class="tag">💰 잔액: ${balance.toLocaleString()}원</span>
                    <button class="btn btn-primary" onclick="window.location.href='index.html'">플러그인 스토어</button>
                </div>
            </div>`;

        // 다운로드 내역
        const list = document.getElementById('downloadsList');
        const dls = user.downloads||[];
        if(dls.length===0){ list.innerHTML = `<div class="card" style="text-align:center;color:var(--text-secondary)">다운로드 내역이 없습니다.</div>`; return; }

        list.innerHTML = dls.map(rec=>{
            const plugin = plugins[rec.pluginId];
            if(!plugin){
                return `<div class="card"><div style="font-weight:bold;color:var(--text-primary)">${rec.pluginName}</div><div class="meta">플러그인 정보 없음 · ${rec.date}</div></div>`
            }
            const paid = plugin.type==='paid' && (plugin.price||0)>0;
            const head = `<div class="row" style="justify-content:space-between">
                <div>
                    <div style="font-weight:bold;color:var(--text-primary)">${rec.pluginName}</div>
                    <div class="meta">${plugin.description||''}</div>
                    <div class="row" style="margin-top:8px"><span class="tag">v${plugin.version}</span>${paid?`<span class="tag">💰 ${(plugin.price||0).toLocaleString()}원 구매</span>`:`<span class="tag">🎁 무료</span>`}</div>
                    <div class="meta" style="margin-top:6px">📅 ${rec.date}</div>
                </div>
            </div>`;

            // PartyPlugin만 버전 선택 제공
            if(plugin.id==='p10' && plugin.versions){
                const vid = `ver_${plugin.id}`;
                const options = Object.keys(plugin.versions).map(v=>`<option value="${v}">${v}</option>`).join('');
                return `<div class="card">${head}
                    <div class="row" style="margin-top:12px">
                        <select id="${vid}"><option value="">기본</option>${options}</select>
                        <button class="btn btn-primary" onclick="reDownloadVersion('${plugin.id}','${vid}')">버전별 다운로드</button>
                    </div>
                </div>`
            }
            // 기타 플러그인: 재다운 버튼
            return `<div class="card">${head}
                <div class="row" style="margin-top:12px">
                    <button class="btn btn-primary" onclick="reDownload('${plugin.id}')">다시 다운로드</button>
                </div>
            </div>`
        }).join('');
    }

    window.reDownload=function(pluginId){
        const plugins = loadPlugins();
        const plugin = plugins[pluginId];
        if(!plugin){ alert('플러그인 정보 없음'); return; }
        const url = plugin.downloadUrl;
        window.open(url,'_blank');
    }
    window.reDownloadVersion=function(pluginId, selectId){
        const plugins = loadPlugins();
        const plugin = plugins[pluginId];
        if(!plugin){ alert('플러그인 정보 없음'); return; }
        const sel = document.getElementById(selectId);
        const v = sel? sel.value : '';
        let url = plugin.downloadUrl;
        if(v && plugin.versions && plugin.versions[v]) url = plugin.versions[v];
        window.open(url,'_blank');
    }

    document.addEventListener('DOMContentLoaded', render);
    </script>
</body>
</html>
