<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plugin Store</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}.container{max-width:1400px;margin:0 auto}header{background:rgba(255,255,255,0.95);padding:30px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.2);margin-bottom:30px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:20px}.header-left h1{color:#667eea;font-size:2.5em;margin-bottom:10px}.subtitle{color:#666;font-size:1.1em}.user-info{text-align:right}.user-name{font-size:1.2em;color:#333;margin-bottom:5px}.user-id{color:#666;font-size:0.9em}.user-stats{display:flex;gap:15px;margin-top:10px;font-size:0.9em}.stat-item{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:5px 12px;border-radius:15px}.btn-logout{margin-top:10px;padding:8px 20px;background:#ef4444;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.9em}.btn-logout:hover{background:#dc2626}.search-section{background:white;padding:20px;border-radius:15px;margin-bottom:20px;box-shadow:0 5px 20px rgba(0,0,0,0.1)}.search-bar{display:flex;gap:10px;margin-bottom:15px}.search-input{flex:1;padding:15px;border:2px solid #e5e7eb;border-radius:10px;font-size:1em}.search-input:focus{outline:none;border-color:#667eea}.btn-search{padding:15px 30px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:10px;cursor:pointer;font-size:1em;font-weight:bold}.category-tags{display:flex;gap:10px;flex-wrap:wrap}.category-tag{padding:8px 15px;background:#f3f4f6;border:none;border-radius:20px;cursor:pointer;font-size:0.9em}.category-tag:hover{background:#e5e7eb}.category-tag.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white}.filters{display:flex;gap:15px;margin-bottom:30px;flex-wrap:wrap;align-items:center}.filter-btn{background:white;border:none;padding:12px 25px;border-radius:25px;cursor:pointer;font-size:1em;box-shadow:0 4px 15px rgba(0,0,0,0.1)}.filter-btn:hover{transform:translateY(-2px)}.filter-btn.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white}.sort-select{padding:12px 20px;border:none;border-radius:25px;background:white;cursor:pointer;font-size:1em;box-shadow:0 4px 15px rgba(0,0,0,0.1)}.plugins-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:25px;margin-bottom:30px}.plugin-card{background:white;border-radius:15px;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,0.1);transition:all 0.3s;cursor:pointer}.plugin-card:hover{transform:translateY(-5px);box-shadow:0 15px 40px rgba(0,0,0,0.2)}.plugin-title{font-size:1.5em;color:#333;margin-bottom:5px}.plugin-badge{padding:5px 15px;border-radius:20px;font-size:0.85em;font-weight:bold;background:#10b981;color:white}.plugin-category{display:inline-block;padding:3px 10px;background:#f3f4f6;border-radius:10px;font-size:0.8em;color:#666;margin-bottom:10px}.plugin-description{color:#666;margin-bottom:15px;line-height:1.6}.plugin-version{color:#999;font-size:0.9em;margin-bottom:15px}.plugin-rating{display:flex;align-items:center;gap:5px;margin-bottom:10px}.stars{color:#fbbf24}.rating-count{color:#999;font-size:0.9em}.plugin-downloads{color:#666;font-size:0.9em;margin-bottom:15px}.plugin-footer{display:flex;gap:10px}.btn{flex:1;padding:12px;border:none;border-radius:10px;cursor:pointer;font-size:1em;font-weight:bold;transition:all 0.3s}.btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white}.btn-primary:hover{transform:scale(1.05)}.btn-secondary{background:#f3f4f6;color:#667eea}.btn-secondary:hover{background:#e5e7eb}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;justify-content:center;align-items:center}.modal.active{display:flex}.modal-content{background:white;padding:40px;border-radius:20px;max-width:600px;width:90%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)}.modal-header{font-size:1.8em;margin-bottom:20px;color:#333}.modal-body{margin-bottom:20px;line-height:1.8;color:#666}.modal-footer{display:flex;gap:10px}.form-group{display:flex;flex-direction:column;gap:5px}.form-group label{color:#333;font-weight:bold}.form-group input,.form-group textarea{padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:1em;font-family:inherit}.form-group input:focus,.form-group textarea:focus{outline:none;border-color:#667eea}.star-rating{display:flex;gap:5px;font-size:2em}.star{cursor:pointer;color:#d1d5db}.star:hover,.star.active{color:#fbbf24}.reviews-section{margin-top:20px;padding-top:20px;border-top:2px solid #e5e7eb}.review-item{background:#f9fafb;padding:15px;border-radius:10px;margin-bottom:15px}.review-header{display:flex;justify-content:space-between;margin-bottom:10px}.review-author{font-weight:bold;color:#333}.review-date{color:#999;font-size:0.9em}.review-text{color:#666;line-height:1.6}.history-btn{position:fixed;bottom:30px;right:30px;background:white;padding:15px 20px;border-radius:30px;box-shadow:0 10px 30px rgba(0,0,0,0.2);cursor:pointer;z-index:100;font-weight:bold;color:#667eea}.history-item{background:#f9fafb;padding:20px;border-radius:10px;margin-bottom:15px;border-left:4px solid #667eea}.discord-login-container{text-align:center;padding:40px 20px}.discord-logo{font-size:5em;margin-bottom:20px;animation:pulse 2s infinite}.discord-title{font-size:2em;color:#333;margin-bottom:15px;font-weight:bold}.discord-description{color:#666;font-size:1.1em;margin-bottom:40px;line-height:1.8}.discord-btn{display:inline-flex;align-items:center;gap:12px;padding:18px 40px;background:linear-gradient(135deg,#5865F2 0%,#424FEF 100%);color:white;border:none;border-radius:12px;font-size:1.2em;font-weight:bold;cursor:pointer;transition:all 0.3s;box-shadow:0 8px 25px rgba(88,101,242,0.4)}.discord-btn:hover{transform:translateY(-3px);box-shadow:0 12px 35px rgba(88,101,242,0.5)}.discord-info{background:linear-gradient(135deg,#f3f4f6 0%,#e5e7eb 100%);padding:20px;border-radius:12px;margin-top:30px;font-size:0.95em;color:#555;text-align:left;border-left:4px solid #5865F2}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}@media(max-width:768px){.plugins-grid{grid-template-columns:1fr}header{flex-direction:column;text-align:center}}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1>ğŸ® Plugin Store</h1>
                <p class="subtitle">ë§ˆì¸í¬ë˜í”„íŠ¸ í”ŒëŸ¬ê·¸ì¸ ìŠ¤í† ì–´</p>
            </div>
            <div class="user-info" id="userInfo" style="display:none">
                <p class="user-name" id="userName"></p>
                <p class="user-id" id="userIdDisplay"></p>
                <div class="user-stats">
                    <span class="stat-item">ğŸ“¥ <span id="downloadCount">0</span>ê°œ</span>
                    <span class="stat-item">â­ <span id="avgRating">0.0</span></span>
                </div>
                <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </header>
        <div class="search-section">
            <div class="search-bar">
                <input type="text" class="search-input" id="searchInput" placeholder="ê²€ìƒ‰...">
                <button class="btn-search" onclick="searchPlugins()">ğŸ”</button>
            </div>
            <div class="category-tags">
                <button class="category-tag active" data-category="all">ì „ì²´</button>
                <button class="category-tag" data-category="ê²Œì„í”Œë ˆì´">ê²Œì„í”Œë ˆì´</button>
                <button class="category-tag" data-category="ì‹œìŠ¤í…œ">ì‹œìŠ¤í…œ</button>
                <button class="category-tag" data-category="ì»¤ìŠ¤í…€">ì»¤ìŠ¤í…€</button>
                <button class="category-tag" data-category="RPG">RPG</button>
                <button class="category-tag" data-category="ê²½ì œ">ê²½ì œ</button>
            </div>
        </div>
        <div class="filters">
            <button class="filter-btn active" data-filter="all">ì „ì²´</button>
            <button class="filter-btn" data-filter="free">ë¬´ë£Œ</button>
            <button class="filter-btn" data-filter="downloaded">ë‹¤ìš´ë¡œë“œí•¨</button>
            <select class="sort-select" id="sortSelect">
                <option value="popular">ì¸ê¸°ìˆœ</option>
                <option value="rating">í‰ì ìˆœ</option>
                <option value="downloads">ë‹¤ìš´ë¡œë“œìˆœ</option>
            </select>
        </div>
        <div class="plugins-grid" id="pluginsGrid"></div>
    </div>
    <div class="history-btn" id="historyBtn" onclick="showHistory()" style="display:none">ğŸ“œ</div>
    <div class="modal active" id="loginModal">
        <div class="modal-content">
            <div class="discord-login-container">
                <div class="discord-logo">ğŸ’¬</div>
                <h2 class="discord-title">Plugin Store</h2>
                <p class="discord-description">
                    ë””ìŠ¤ì½”ë“œ ì„œë²„ì— ì°¸ì—¬í•˜ê³ <br>
                    ë””ìŠ¤ì½”ë“œ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”!
                </p>
                <div style="display:flex;justify-content:center;margin:30px 0">
                    <iframe src="https://discord.com/widget?id=1420030738346152093&theme=dark" width="350" height="500" allowtransparency="true" frameborder="0" sandbox="allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts" style="border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,0.3)"></iframe>
                </div>
                <button class="discord-btn" onclick="discordLogin()">
                    <span style="font-size:1.3em">ğŸ’¬</span>
                    <span>Discordë¡œ ë¡œê·¸ì¸</span>
                </button>
                <div class="discord-info">
                    <strong>ğŸ”’ ì•ˆì „í•œ ì¸ì¦</strong><br>
                    â€¢ Discord OAuth 2.0 ê³µì‹ ì¸ì¦ ì‹œìŠ¤í…œ<br>
                    â€¢ ìœ„ ìœ„ì ¯ì—ì„œ ì„œë²„ì— ì°¸ì—¬í•˜ì„¸ìš”<br>
                    â€¢ ë¡œê·¸ì¸ í›„ ëª¨ë“  í”ŒëŸ¬ê·¸ì¸ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <h2 class="modal-header" id="modalTitle"></h2>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDetailModal()">ë‹«ê¸°</button>
                <button class="btn btn-primary" id="modalAction"></button>
            </div>
        </div>
    </div>
    <div class="modal" id="reviewModal">
        <div class="modal-content">
            <h2 class="modal-header">â­ ë¦¬ë·° ì‘ì„±</h2>
            <div class="modal-body">
                <div class="form-group">
                    <label>í‰ì </label>
                    <div class="star-rating" id="starRating">
                        <span class="star" data-rating="1">â˜…</span>
                        <span class="star" data-rating="2">â˜…</span>
                        <span class="star" data-rating="3">â˜…</span>
                        <span class="star" data-rating="4">â˜…</span>
                        <span class="star" data-rating="5">â˜…</span>
                    </div>
                </div>
                <div class="form-group"><label>ë¦¬ë·°</label><textarea id="reviewText" rows="5"></textarea></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeReviewModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="submitReview()">ë“±ë¡</button>
            </div>
        </div>
    </div>
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <h2 class="modal-header">ğŸ“œ ë‹¤ìš´ë¡œë“œ ë‚´ì—­</h2>
            <div class="modal-body" id="historyBody"></div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="closeHistoryModal()">ë‹«ê¸°</button></div>
        </div>
    </div>
    <script>
let plugins={},currentUser=null,currentFilter='all',currentCategory='all',currentSort='popular',selectedRating=0,currentPlugin=null,discordMembers=[];
const WEBHOOK='https://discord.com/api/webhooks/1425431420158869584/_H7Fr8vnzydAuqVoQ8Sbm5c2wHlb7EL8XXAIadq1waQGaaPCvJYGjhQotyWU4DHY0-zv';
const DISCORD_CLIENT_ID='1414591036734312499';
const DISCORD_WIDGET_API='https://discord.com/api/guilds/1420030738346152093/widget.json';
const REDIRECT_URI=window.location.origin+window.location.pathname;
const initialData={p1:{id:'p1',name:"CookingPlugin",description:"ìš”ë¦¬ ì‹œìŠ¤í…œ",version:"1.0",type:"free",category:"ê²Œì„í”Œë ˆì´",downloads:0,rating:0,reviews:{},downloadUrl:"https://www.dropbox.com/scl/fi/uqe6g4wu4vwlfh46qd9i4/CookingPlugin.jar?rlkey=nrxb0beuwyjbxqxq8d9w2oei4&st=sv9nvc3q&dl=1"},p2:{id:'p2',name:"ItemsAdder",description:"ì»¤ìŠ¤í…€ ì•„ì´í…œ",version:"1.2",type:"free",category:"ì»¤ìŠ¤í…€",downloads:0,rating:0,reviews:{},downloadUrl:"https://www.dropbox.com/scl/fi/jnqiumuvlm9ibos0amapv/itemsadder-1.2-paper.jar?rlkey=37p1s990yx23j2c6b4j3sjpv6&st=u3c9s9qf&dl=1"},p3:{id:'p3',name:"QuestPlugin",description:"í€˜ìŠ¤íŠ¸ ì‹œìŠ¤í…œ",version:"1.5",type:"free",category:"RPG",downloads:0,rating:0,reviews:{},downloadUrl:"https://www.dropbox.com/scl/fi/j7d7lh2skws90d3hqrwa1/QuestPlugin-1.5-paper.jar?rlkey=9h8n0sr4tyem40jb2bemdok6k&st=31siar1m&dl=1"},p4:{id:'p4',name:"RankPlugin",description:"ë“±ê¸‰ ì‹œìŠ¤í…œ",version:"1.0",type:"free",category:"ì‹œìŠ¤í…œ",downloads:0,rating:0,reviews:{},downloadUrl:"https://www.dropbox.com/scl/fi/o3ig4n0gxrlxuz01j1j7r/rankplugin-1.0-paper.jar?rlkey=t699uhu6eck878a6u6y36f8fq&st=i4gpgqga&dl=1"},p5:{id:'p5',name:"RoulettePlugin",description:"ë£°ë ›",version:"1.0",type:"free",category:"ê²Œì„í”Œë ˆì´",downloads:0,rating:0,reviews:{},downloadUrl:"https://www.dropbox.com/scl/fi/fsrnzk9u7vet81euq3afr/RoulettePlugin-1.0-paper.jar?rlkey=yi40cimkve8lim2cg4isr8n6k&st=qbfrlmyz&dl=1"},p6:{id:'p6',name:"ShopSystem",description:"ìƒì ",version:"1.2",type:"free",category:"ê²½ì œ",downloads:0,rating:0,reviews:{},downloadUrl:"https://www.dropbox.com/scl/fi/ld31twop0v6v454dhhet0/Shopsystem-1.2-paper.jar?rlkey=we1a2xxv5m25lq1wghj0o1ugf&st=068q0ixb&dl=1"},p7:{id:'p7',name:"SkillSystem",description:"ìŠ¤í‚¬",version:"1.0",type:"free",category:"RPG",downloads:0,rating:0,reviews:{},downloadUrl:"https://www.dropbox.com/scl/fi/akw2azo96zgw4pjp1jus2/SkillSystem-1.0-paper.jar?rlkey=m3dxjilfwgm9gt68vpzk9yhlh&st=a5cn74qy&dl=1"},p8:{id:'p8',name:"SpectatorOnDeath",description:"ê´€ì „",version:"1.0",type:"free",category:"ê²Œì„í”Œë ˆì´",downloads:0,rating:0,reviews:{},downloadUrl:"https://www.dropbox.com/scl/fi/xc2fyqs65nuymhhqwzuc3/SpectatorOnDeath-1.0-paper.jar?rlkey=fwmas7lvqek4ej1atni7gwki5&st=sutonbm3&dl=1"},p9:{id:'p9',name:"SwordPlugin",description:"ê²€",version:"1.2",type:"free",category:"ì»¤ìŠ¤í…€",downloads:0,rating:0,reviews:{},downloadUrl:"https://www.dropbox.com/scl/fi/seacbjovms352dw3yyga9/sword-1.2-paper.jar?rlkey=5cdesj2v2ax436ze7905fiifp&st=szgdpnve&dl=1"}};

async function loadDiscordMembers(){
    try{
        const res=await fetch(DISCORD_WIDGET_API);
        const data=await res.json();
        if(data.members){
            discordMembers=data.members.map(m=>({
                id:m.id,
                username:m.username,
                discriminator:m.discriminator
            }));
            console.log('Discord ë©¤ë²„ ë¡œë“œ ì™„ë£Œ:',discordMembers.length+'ëª…');
        }
    }catch(e){
        console.error('Discord API ë¡œë“œ ì‹¤íŒ¨:',e);
    }
}

function loadLocal(){const s=localStorage.getItem('plugins');plugins=s?JSON.parse(s):initialData}
function saveLocal(){localStorage.setItem('plugins',JSON.stringify(plugins))}
async function sendDiscord(msg){try{await fetch(WEBHOOK,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({embeds:[{title:"ğŸ“¥ ì•Œë¦¼",description:msg,color:6750054,timestamp:new Date().toISOString()}]})})}catch(e){}}

function init(){
    loadLocal();
    loadDiscordMembers();
    setupListeners();
    renderPlugins();
    handleOAuthCallback();
    const u=localStorage.getItem('currentUser');
    if(u){
        currentUser=JSON.parse(u);
        showUserInfo();
    }
}

function handleOAuthCallback(){
    const params=new URLSearchParams(window.location.search);
    const code=params.get('code');
    
    if(code){
        const state=params.get('state');
        const minecraftId=state?decodeURIComponent(state):'Player'+Math.floor(Math.random()*9999);
        
        currentUser={
            discordCode:code,
            minecraftId:minecraftId,
            username:minecraftId,
            loginTime:new Date().toISOString(),
            downloads:[],
            reviews:{}
        };
        
        localStorage.setItem('currentUser',JSON.stringify(currentUser));
        window.history.replaceState({},document.title,window.location.pathname);
        document.getElementById('loginModal').classList.remove('active');
        showUserInfo();
        renderPlugins();
        
        sendDiscord(`**âœ… ìƒˆë¡œìš´ ë¡œê·¸ì¸**\n**ë””ìŠ¤ì½”ë“œ ì¸ì¦ ì™„ë£Œ**\n**ë§ˆì¸í¬ë˜í”„íŠ¸:** ${currentUser.minecraftId}\n**ì‹œê°„:** ${new Date().toLocaleString('ko-KR')}`);
    }
}

function showUserInfo(){
    document.getElementById('userName').textContent=(currentUser.username||'User')+'ë‹˜';
    document.getElementById('userIdDisplay').textContent='MC: '+currentUser.minecraftId;
    document.getElementById('userInfo').style.display='block';
    document.getElementById('historyBtn').style.display='block';
    document.getElementById('loginModal').classList.remove('active');
    updateUserStats();
}

function setupListeners(){
    document.querySelectorAll('.category-tag').forEach(t=>t.addEventListener('click',function(){
        document.querySelectorAll('.category-tag').forEach(x=>x.classList.remove('active'));
        this.classList.add('active');
        currentCategory=this.dataset.category;
        renderPlugins();
    }));
    document.querySelectorAll('.filter-btn').forEach(b=>b.addEventListener('click',function(){
        document.querySelectorAll('.filter-btn').forEach(x=>x.classList.remove('active'));
        this.classList.add('active');
        currentFilter=this.dataset.filter;
        renderPlugins();
    }));
    document.getElementById('sortSelect').addEventListener('change',function(){
        currentSort=this.value;
        renderPlugins();
    });
    document.getElementById('searchInput').addEventListener('keypress',function(e){
        if(e.key==='Enter')searchPlugins();
    });
    document.querySelectorAll('#starRating .star').forEach(s=>s.addEventListener('click',function(){
        selectedRating=parseInt(this.dataset.rating);
        document.querySelectorAll('#starRating .star').forEach((x,i)=>{
            if(i<selectedRating)x.classList.add('active');
            else x.classList.remove('active');
        });
    }));
}

window.discordLogin=function(){
    const minecraftId=prompt('ë§ˆì¸í¬ë˜í”„íŠ¸ ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”:','Player'+Math.floor(Math.random()*9999));
    if(!minecraftId)return;
    
    const state=encodeURIComponent(minecraftId);
    const redirectUri=encodeURIComponent(REDIRECT_URI);
    const scopes='identify';
    
    window.location.href=`https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${redirectUri}&response_type=code&scope=${scopes}&state=${state}`;
};

window.logout=function(){
    currentUser=null;
    localStorage.removeItem('currentUser');
    document.getElementById('userInfo').style.display='none';
    document.getElementById('historyBtn').style.display='none';
    document.getElementById('loginModal').classList.add('active');
};

function updateUserStats(){
    if(!currentUser)return;
    const d=currentUser.downloads?currentUser.downloads.length:0;
    const r=currentUser.reviews?Object.values(currentUser.reviews):[];
    const a=r.length>0?(r.reduce((s,x)=>s+x.rating,0)/r.length).toFixed(1):'0.0';
    document.getElementById('downloadCount').textContent=d;
    document.getElementById('avgRating').textContent=a;
}

function renderPlugins(){
    const g=document.getElementById('pluginsGrid');
    let l=Object.values(plugins);
    if(currentCategory!=='all')l=l.filter(p=>p.category===currentCategory);
    if(currentFilter==='free')l=l.filter(p=>p.type==='free');
    else if(currentFilter==='downloaded'&&currentUser)l=l.filter(p=>currentUser.downloads&&currentUser.downloads.some(d=>d.pluginId===p.id));
    const t=document.getElementById('searchInput').value.toLowerCase();
    if(t)l=l.filter(p=>p.name.toLowerCase().includes(t));
    l.sort((a,b)=>{
        if(currentSort==='rating')return(b.rating||0)-(a.rating||0);
        if(currentSort==='downloads')return b.downloads-a.downloads;
        return(b.downloads*(b.rating||0))-(a.downloads*(a.rating||0));
    });
    g.innerHTML=l.map(p=>{
        const i=currentUser&&currentUser.downloads&&currentUser.downloads.some(d=>d.pluginId===p.id);
        const c=p.reviews?Object.keys(p.reviews).length:0;
        const s='â˜…'.repeat(Math.round(p.rating||0))+'â˜†'.repeat(5-Math.round(p.rating||0));
        return`<div class="plugin-card"onclick="showDetail('${p.id}')"><div style="display:flex;justify-content:space-between"><div><h3 class="plugin-title">${p.name}</h3><span class="plugin-category">${p.category}</span></div><span class="plugin-badge">ë¬´ë£Œ</span></div><p class="plugin-description">${p.description}</p><p class="plugin-version">v${p.version}</p><div class="plugin-rating"><span class="stars">${s}</span><span class="rating-count">${(p.rating||0).toFixed(1)}(${c})</span></div><p class="plugin-downloads">ğŸ“¥ ${p.downloads}íšŒ</p>${i?'<div style="background:#10b981;color:white;padding:8px;border-radius:8px;text-align:center;margin:10px 0">âœ“ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ</div>':''}<div class="plugin-footer"><button class="btn btn-primary"onclick="event.stopPropagation();downloadPlugin('${p.id}')">${i?'ì¬ë‹¤ìš´':'ë‹¤ìš´ë¡œë“œ'}</button><button class="btn btn-secondary"onclick="event.stopPropagation();showDetail('${p.id}')">ìƒì„¸ë³´ê¸°</button></div></div>`;
    }).join('');
}

window.searchPlugins=function(){renderPlugins()};

window.showDetail=function(pid){
    currentPlugin=plugins[pid];
    if(!currentPlugin)return;
    const i=currentUser&&currentUser.downloads&&currentUser.downloads.some(d=>d.pluginId===pid);
    const u=currentUser&&currentUser.reviews&&currentUser.reviews[pid];
    document.getElementById('modalTitle').textContent=currentPlugin.name;
    const r=currentPlugin.reviews?Object.values(currentPlugin.reviews):[];
    let h='<div class="reviews-section"><h3>ğŸ“ ë¦¬ë·°('+r.length+')</h3>';
    r.forEach(x=>{
        const s='â˜…'.repeat(x.rating)+'â˜†'.repeat(5-x.rating);
        h+=`<div class="review-item"><div class="review-header"><span class="review-author">${x.author}</span><span class="stars">${s}</span></div><p class="review-text">${x.text}</p><span class="review-date">${x.date}</span></div>`;
    });
    h+='</div>';
    const rating=currentPlugin.rating||0;
    document.getElementById('modalBody').innerHTML=`<p><strong>ì¹´í…Œê³ ë¦¬:</strong> ${currentPlugin.category}</p><p><strong>ë²„ì „:</strong> v${currentPlugin.version}</p><p><strong>í‰ì :</strong> ${rating.toFixed(1)}/5.0</p><p><strong>ë‹¤ìš´ë¡œë“œ:</strong> ${currentPlugin.downloads}íšŒ</p><p style="margin-top:15px">${currentPlugin.description}</p>${h}`;
    const b=document.getElementById('modalAction');
    if(i){
        b.textContent=u?'ë¦¬ë·° ìˆ˜ì •':'ë¦¬ë·° ì‘ì„±';
        b.onclick=()=>openReviewModal(pid);
    }else{
        b.textContent='ë‹¤ìš´ë¡œë“œ';
        b.onclick=()=>{downloadPlugin(pid);closeDetailModal()};
    }
    document.getElementById('detailModal').classList.add('active');
};

window.closeDetailModal=function(){document.getElementById('detailModal').classList.remove('active')};

window.downloadPlugin=async function(pid){
    if(!currentUser){
        alert('ë””ìŠ¤ì½”ë“œ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
        return;
    }
    const p=plugins[pid];
    if(!p)return;
    p.downloads++;
    const rec={pluginId:p.id,pluginName:p.name,date:new Date().toLocaleString('ko-KR')};
    if(!currentUser.downloads)currentUser.downloads=[];
    if(!currentUser.downloads.some(d=>d.pluginId===pid))currentUser.downloads.push(rec);
    saveLocal();
    const l=document.createElement('a');
    l.href=p.downloadUrl;
    l.download=p.name+'.jar';
    document.body.appendChild(l);
    l.click();
    document.body.removeChild(l);
    localStorage.setItem('currentUser',JSON.stringify(currentUser));
    updateUserStats();
    renderPlugins();
    await sendDiscord(`**ğŸ“¥ ë‹¤ìš´ë¡œë“œ**\n**í”ŒëŸ¬ê·¸ì¸:** ${p.name}\n**ì‚¬ìš©ì:** ${currentUser.username}\n**ë§ˆì¸í¬ë˜í”„íŠ¸:** ${currentUser.minecraftId}\n**ì‹œê°„:** ${rec.date}\n**ì´ ë‹¤ìš´ë¡œë“œ:** ${p.downloads}íšŒ`);
    alert('âœ… ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!');
};

window.openReviewModal=function(pid){
    currentPlugin=plugins[pid];
    const u=currentUser.reviews&&currentUser.reviews[pid];
    if(u){
        selectedRating=u.rating;
        document.getElementById('reviewText').value=u.text;
        document.querySelectorAll('#starRating .star').forEach((s,i)=>{
            if(i<selectedRating)s.classList.add('active');
            else s.classList.remove('active');
        });
    }else{
        selectedRating=0;
        document.getElementById('reviewText').value='';
        document.querySelectorAll('#starRating .star').forEach(s=>s.classList.remove('active'));
    }
    closeDetailModal();
    document.getElementById('reviewModal').classList.add('active');
};

window.closeReviewModal=function(){document.getElementById('reviewModal').classList.remove('active')};

window.submitReview=async function(){
    if(!currentUser||!currentPlugin)return;
    if(selectedRating===0){
        alert('ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
        return;
    }
    const t=document.getElementById('reviewText').value.trim();
    if(!t){
        alert('ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
    }
    const r={author:currentUser.username,rating:selectedRating,text:t,date:new Date().toLocaleString('ko-KR')};
    if(!currentPlugin.reviews)currentPlugin.reviews={};
    currentPlugin.reviews[currentUser.minecraftId]=r;
    const v=Object.values(currentPlugin.reviews);
    const a=v.reduce((s,x)=>s+x.rating,0)/v.length;
    currentPlugin.rating=Math.round(a*10)/10;
    if(!currentUser.reviews)currentUser.reviews={};
    currentUser.reviews[currentPlugin.id]=r;
    saveLocal();
    localStorage.setItem('currentUser',JSON.stringify(currentUser));
    closeReviewModal();
    updateUserStats();
    renderPlugins();
    alert('âœ… ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
};

window.showHistory=function(){
    if(!currentUser)return;
    const b=document.getElementById('historyBody');
    const d=currentUser.downloads||[];
    b.innerHTML=d.length===0?'<p style="text-align:center;color:#999">ë‹¤ìš´ë¡œë“œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>':d.map(x=>`<div class="history-item"><h3>${x.pluginName}</h3><p style="color:#999;font-size:0.9em">${x.date}</p><button class="btn btn-primary"onclick="downloadPlugin('${x.pluginId}')">ì¬ë‹¤ìš´ë¡œë“œ</button></div>`).join('');
    document.getElementById('historyModal').classList.add('active');
};

window.closeHistoryModal=function(){document.getElementById('historyModal').classList.remove('active')};

document.addEventListener('DOMContentLoaded',init);
    </script>
</body>
</html>
