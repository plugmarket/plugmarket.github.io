<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리 툴 - Plugin Store</title>
    <style>
        :root{
            --bg-primary:#ffffff;
            --bg-secondary:#ffffff;
            --text-primary:#333;
            --text-secondary:#666;
            --border-color:#e5e7eb;
            --card-bg:#ffffff;
            --shadow:rgba(0,0,0,0.08);
            --danger:#ef4444;
            --success:#10b981;
        }
        body.dark-mode{
            --bg-primary:#1a1a1a;
            --bg-secondary:#2d2d2d;
            --text-primary:#e5e5e5;
            --text-secondary:#b3b3b3;
            --border-color:#404040;
            --card-bg:#2d2d2d;
            --shadow:rgba(0,0,0,0.3);
        }
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',sans-serif;background:var(--bg-primary);min-height:100vh;padding:20px;transition:background 0.3s ease}
        .container{max-width:1200px;margin:0 auto}
        header{background:var(--card-bg);padding:30px;border-radius:20px;box-shadow:0 2px 10px var(--shadow);margin-bottom:30px;display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border-color)}
        h1{color:#667eea;font-size:2em}
        .nav-buttons{display:flex;gap:10px}
        .btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:1em;transition:all 0.3s}
        .btn-primary{background:#667eea;color:white}
        .btn-danger{background:var(--danger);color:white}
        .btn:hover{transform:scale(1.05)}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
        .stat-card{background:var(--card-bg);padding:25px;border-radius:15px;box-shadow:0 2px 10px var(--shadow);border:1px solid var(--border-color)}
        .stat-number{font-size:2.5em;color:#667eea;font-weight:bold}
        .stat-label{color:var(--text-secondary);margin-top:10px}
        .table-container{background:var(--card-bg);padding:25px;border-radius:15px;box-shadow:0 2px 10px var(--shadow);border:1px solid var(--border-color);overflow-x:auto}
        table{width:100%;border-collapse:collapse}
        th,td{padding:15px;text-align:left;border-bottom:1px solid var(--border-color)}
        th{color:var(--text-primary);font-weight:bold;background:var(--bg-tertiary)}
        td{color:var(--text-secondary)}
        .badge{padding:5px 12px;border-radius:15px;font-size:0.85em;font-weight:bold}
        .badge-success{background:#10b981;color:white}
        .theme-toggle{position:fixed;top:20px;right:20px;background:var(--card-bg);border:2px solid var(--border-color);padding:12px 16px;border-radius:50px;cursor:pointer;font-size:1.5em;box-shadow:0 4px 15px var(--shadow);z-index:1000}
        .theme-toggle:hover{transform:scale(1.1)}
        .alert{background:#fee;border:1px solid #fcc;color:#c33;padding:15px;border-radius:10px;margin-bottom:20px}
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()" title="테마 전환">🌓</button>
    <div class="container">
        <header>
            <h1>⚙️ 관리 툴</h1>
            <div class="nav-buttons">
                <button class="btn btn-primary" onclick="window.location.href='index.html'">← 메인으로</button>
                <button class="btn btn-danger" onclick="logout()">로그아웃</button>
            </div>
        </header>
        
        <div id="accessDenied" class="alert" style="display:none">
            ❌ 접근 거부: 관리자만 접근 가능합니다.
        </div>
        
        <div id="adminContent" style="display:none">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalPlugins">0</div>
                    <div class="stat-label">총 플러그인</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalDownloads">0</div>
                    <div class="stat-label">총 다운로드</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">0</div>
                    <div class="stat-label">총 사용자</div>
                </div>
            </div>
            
            <div class="table-container">
                <h2 style="margin-bottom:20px;color:var(--text-primary)">플러그인 목록</h2>
                <table id="pluginsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>이름</th>
                            <th>카테고리</th>
                            <th>다운로드</th>
                            <th>평점</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody id="pluginsBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB_FsD_GqnENdMGeuzH5Q8tICxn_fgu7OQ",
      authDomain: "plugmarketdb.firebaseapp.com",
      databaseURL: "https://plugmarketdb-default-rtdb.firebaseio.com",
      projectId: "plugmarketdb",
      storageBucket: "plugmarketdb.firebasestorage.app",
      messagingSenderId: "142551495005",
      appId: "1:142551495005:web:6b2b02b9ea53b4198138b4",
      measurementId: "G-3YMWZPCFWQ"
    };
    
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const ADMIN_DISCORD_ID = '787223885766328340';
    
    let currentUser = null;
    let plugins = {};
    
    function checkAdmin(){
        const user = localStorage.getItem('currentUser');
        if(!user) return false;
        currentUser = JSON.parse(user);
        // Discord ID로 관리자 체크
        return currentUser.discordId === ADMIN_DISCORD_ID;
    }
    
    function loadPlugins(){
        const stored = localStorage.getItem('plugins');
        if(stored){
            plugins = JSON.parse(stored);
        }
        return plugins;
    }
    
    function renderStats(){
        const pluginCount = Object.keys(plugins).length;
        const totalDownloads = Object.values(plugins).reduce((sum, p) => sum + (p.downloads || 0), 0);
        
        document.getElementById('totalPlugins').textContent = pluginCount;
        document.getElementById('totalDownloads').textContent = totalDownloads;
        document.getElementById('totalUsers').textContent = '-';
    }
    
    function renderPluginsTable(){
        const tbody = document.getElementById('pluginsBody');
        tbody.innerHTML = Object.values(plugins).map(p => `
            <tr>
                <td>${p.id}</td>
                <td><strong>${p.name}</strong></td>
                <td><span class="badge badge-success">${p.category}</span></td>
                <td>${p.downloads || 0}</td>
                <td>${(p.rating || 0).toFixed(1)}</td>
                <td>
                    <button class="btn btn-primary" onclick="resetDownloads('${p.id}')">다운로드 초기화</button>
                </td>
            </tr>
        `).join('');
    }
    
    async function resetDownloads(pluginId){
        if(!confirm(`${plugins[pluginId].name}의 다운로드 횟수를 0으로 초기화하시겠습니까?`)) return;
        
        plugins[pluginId].downloads = 0;
        localStorage.setItem('plugins', JSON.stringify(plugins));
        
        // Firebase 업데이트
        try {
            await database.ref(`plugins/${pluginId}/downloads`).set(0);
        } catch(e) {
            console.error('Firebase 업데이트 실패:', e);
        }
        
        renderStats();
        renderPluginsTable();
        alert('초기화 완료!');
    }
    
    function logout(){
        if(confirm('로그아웃 하시겠습니까?')){
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }
    }
    
    function toggleTheme(){
        const body = document.body;
        const isDark = body.classList.toggle('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        updateThemeIcon();
    }
    
    function updateThemeIcon(){
        const toggle = document.querySelector('.theme-toggle');
        if(document.body.classList.contains('dark-mode')){
            toggle.textContent = '☀️';
        } else {
            toggle.textContent = '🌓';
        }
    }
    
    function loadTheme(){
        const savedTheme = localStorage.getItem('theme');
        if(savedTheme === 'dark'){
            document.body.classList.add('dark-mode');
        }
        updateThemeIcon();
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        loadTheme();
        
        if(!checkAdmin()){
            document.getElementById('accessDenied').style.display = 'block';
        } else {
            document.getElementById('adminContent').style.display = 'block';
            loadPlugins();
            renderStats();
            renderPluginsTable();
        }
    });
    </script>
</body>
</html>

